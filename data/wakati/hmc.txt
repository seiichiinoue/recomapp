Hamiltonian MCMC を 用い た CSTM の 推定 
Hamiltonian MCMC 法 
本 ブログ で は 詳細 な 理論 の 説明 は 割愛 し ます ． 詳しく は ， 「 基礎 から の ベイズ 統計 学 ハミルトニアンモンテカルロ 法 による 実践 的 入門 」 や ， Neal の MCMC using Hamiltonian Dynamics を 参照 し て ください ． 
ここ で は ， できるだけ 簡単 に Hamiltonian MCMC 法 の イメージ を 書き ます ． 
以下 は ほとんど 清水 先生 の ブログ から の 引用 です ． 
Hamiltonian MCMC 法 は ， 物理 学 の アナロジー を 用い て 推移 確率 を 決め ます ． 事後 分布 の 形 が ガウス 分布 だ と 仮定 する と ， ガウス 分布 の 平均 の 尤 度 関数 は 正規 分布 に 比例 し ， 事前 分布 に 一様 分布 を 仮定 する と ， 事後 分布 は 尤 度 と 事前 分布 の 積 で 表さ れる ので ， 正規 分布 と なり ます ． 
この 乱数 を 生成 し たい として ， HMC で は 事後 分布 の 形状 が わかる こと を 利用 し ます ． 
まず ， 事後 分布 の 対数 の 符号 反転 ， つまり 情報 量 の 関数 を 考え ます ． 
ここ で ， 玉 を 適当 な 場所 において 転がす 事 を 考え ます ． その とき ， 正規 乱数 によって 転がす 強 さ （ 運動 量 ） を 決め ます ． 強く 弾く と 一 回 遠く まで 転がっ て また 落ち て き て という よう に 幅広い 範囲 で 転がり 続け ます ． 弱く 弾く と ， 下 の ほう で 転がっ てる 状態 に なる でしょ う ． 摩擦 が なけれ ば 運動 量 と 位置 ネルギー の 合計 （ これ を ハミルトニアン と いい ます ） は 一定 に なる よう に ， ずっと 転がり 続け ます ． HMC で は 転がす 時間 を 予め 決め て おい て ， その 時間 に なっ たら 玉 を 止め ます ． 止まっ た ところ の X 軸 の 値 が ， 次 の パラメータ の 値 と する ． という 方法 です ． 
次 の パラメータ は ， 前回 の パラメータ の 位置 から また 正規 乱数 によって 決め た 運動 量 で 弾い て という こと を 繰り返し ます 。 この 「 ある 値 から 乱数 で 決め た 強 さ で 玉 を 弾い て ， 一定 時間 立っ て 止め た 場所 が 次 の パラメータ の 値 」 という 更新 自体 が ， 推移 確率 に なっ て いる という こと です ． 
HMC で は ， 基本 的 に は 密度 の 高い ところ （ 下 の 方 ） に 転がる こと が 多く なり ， たまに 強く 弾く こと で 事後 分布 の 端 の ほう も サンプリング できる ， そういう アルゴリズム に なっ て い ます ． また ， 密度 の 高い ところ から 離れ た パラメータ が 生成 さ れ た 場合 ， 位置 エネルギー が 大きい ため ， 広い 範囲 に 転がり ， 密度 の 高い ところ に パラメータ が 生成 さ れ た 場合 は ， 位置 エネルギー が 小さい ため 比較的 近く を 転がり やすく なり ます ． この よう に ， 密度 が 高い ところ に 集中 する よう に なる 一方 ， 自己 相関 が 低い 乱数 を 生成 する こと が でき ます ． 
実際 に は ， 玉 が どこ に ある か を 判別 する ため に ， 時間 を 短い 間隔 で 区切っ て ， 離散 的 に 玉 の 状態 を 判断 し ます ． この とき ， 微小 時間 を epsilon ， その 判定 を 何 回 する か を L という ハイパーパラメータ で 決め ます ． L と epsilon の 積 が 玉 を 転がす 時間 という わけ です ． 
CSTM 
CSTM は 以前 僕 の ブログ で 紹介 し て い ます ． 詳細 は https :// seiichiinoue . github . io / post / cstm / を 見 て ください ． 
CSTM の 生成 過程 は 次 の よう に なり ます ． 
単語 ベクトル を と し ， 文書 ベクトル を と し た とき ， どちら も 同じ 潜在 空間 上 で 考え て いる ので ， 内積 を とっ て ， その 近 さ によって 単語 の 確率 を 操作 する よう な モデル です ． 
文書 ごと に 単語 の 確率 を きめ 細やか に 変更 できる の が 特徴 です ． 
HMC による CSTM の 推定 
CSTM の 事後 分布 は ， Polya 分布 の 積 に 従う ので ， Polya 分布 の 対数 の 符号 反転 が 位置 エネルギー () と なり ます ． 
また ， HMC で は ， 以下 の ハミルトニアン を 用い て パラメータ の 候補 を 受諾 ・ 棄却 し ます ． 
ここ で ， は パラメータ の ベクトル で ， p は 運動 量 です ． 
次に ， パラメータ の 移動 を 考え ます ． HMC で は ， 次 の 時点 の パラメータ は 位置 エネルギー の 勾配 を 用い て 計算 さ れ ます ． 
理論 の 詳細 は 割愛 し ます が ， ハミルトニアン が 一定 の ところ を うまく 数値 計算 する 手法 として ， リープフロッグ 法 が 用い られ ます ． 
更新 手順 は 簡単 に まとめる と 次 の よう に なり ます ． 
を 初期 化 
位置 エネルギー の 勾配 を 使っ て 次 の 時点 の を 計算 
を 使っ て を 計算 
2 と 同様 に を 計算 
それでは 実装 を 行っ て いき ます ． コード は Github に 公開 し て い ます ． 以下 で は 未 定義 の 関数 が 現れ ます が ， 関数 名 で 戻り 値 が 推測 できる もの として 取り扱っ て い ます ． 
CSTM で は ， 推定 パラメータ が 単語 ベクトル ， 文書 ベクトル ， が の 3 つ ある ので ， ランダム ウォーク MH 法 など と 同様 に それぞれ 独立 に サンプリング し て 更新 し て いき ます ． 
以下 で は 単語 ベクトル の 更新 過程 のみ 掲載 し ます ． （ 他 は ほとんど 一緒 です ） 
まず ， Step 1 の パラメータ の 初期 化 について です ． 
ただし ， 予備 実験 の 結果 から と し まし た ． 
次に ， 位置 エネルギー の 勾配 を 計算 し ます ． しかし CSTM は 事後 分布 の 微分 が 閉じ た 式 と なっ て い ない ため ， 数値 微分 を 用い て 計算 し ます ． 
テイラー 展開 による 3 点 近似 を 用い て 計算 し ます ． 具体 的 に は 実際 に 値 を 左右 に 微小 値 だけ 動かし て ， その間 数値 を 計算 し ， 勾配 を 求め ます ． （ ただし 計算 量 の オーダー が えぐい です ． ） 
勾配 が 求まっ た ので ， 次に 勾配 を 用い て を 更新 し ます ． 0 . 5 ステップ 後 の は 次 の よう に 計算 さ れ ます ． 
そして ， これ を 使っ て 単語 ベクトル の 計算 を し ます ． 
そして ， 1 ステップ 後 の を 計算 し て ， リープフロッグ 法 の 1 iter が 終わり です ． これ を L ( ハイパーパラメータ ) 回 回し て ， 遷移 先 を 決定 し ます ． 
また ， 遷移 先 の 採択 は ， 以前 の パラメータ で の ハミルトニアン と ， 次 時点 の パラメータ の 候補 の ハミルトニアン を 比較 し て 行い ます ． 
これ で 以上 です ． あと は 必要 な epoch 数 回 し ます ． 
実験 も スモール コーパス に対して は 行い まし た が ， 通常 の コーパス に対して は 計算 量 が 多 すぎ て 無理 でし た ． 
特に 数値 微分 の 箇所 の 計算 量 の オーダー が 高い ので 計算 量 を 下げる 方法 など ， 改良 を 検討 し て いき たい と 思い ます ． 
